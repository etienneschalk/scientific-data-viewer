name: Pull Request Validation

on:
    pull_request:
        types: [opened, synchronize, reopened, ready_for_review]
        branches: [main, develop]

concurrency:
    group: pr-${{ github.event.pull_request.number }}
    cancel-in-progress: true

jobs:
    validate-changes:
        name: Validate Changes
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: Checkout PR code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install pre-commit

            - name: Install Node.js dependencies
              run: npm ci

            - name: Run pre-commit on changed files
              uses: pre-commit/action@v3.0.1
              with:
                  extra_args: --verbose

            - name: Check TypeScript compilation
              run: npm run compile

            - name: Run ESLint
              run: npm run lint

            - name: Run tests
              run: npm test

    check-formatting:
        name: Check Code Formatting
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install pre-commit ruff
                  npm ci

            - name: Check Prettier formatting
              run: npx prettier --check "src/**/*.{ts,js,json,md}" "python/**/*.py"

            - name: Check Ruff formatting
              run: ruff format python/ --check
              if: success()

            - name: Check ESLint
              run: npm run lint

    security-check:
        name: Security Check
        runs-on: ubuntu-latest
        timeout-minutes: 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"

            - name: Install dependencies
              run: |
                  npm ci
                  python -m pip install --upgrade pip
                  pip install pre-commit

            - name: Run security audit
              run: npm audit --audit-level=moderate

            - name: Run pre-commit security hooks
              uses: pre-commit/action@v3.0.1
              with:
                  extra_args: --all-files --hook-stage manual
